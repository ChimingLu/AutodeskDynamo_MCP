**Ë™ûË®Ä / Language:** [ÁπÅÈ´î‰∏≠Êñá](README.md) | [English](README_EN.md)

---

# Autodesk Dynamo MCP Integration Project

This is a core integration project that connects **Autodesk Dynamo** to AI systems (such as Claude Desktop) through the **Model Context Protocol (MCP)**.
With this system, AI can directly control Dynamo for BIM automation operations, enabling "zero-intervention" automated modeling and querying.

---

## üöÄ Major Updates: Auto-Start and Centralized Management

1.  **Connection Management**: While the View Extension has auto-start capabilities, it is **strongly recommended** that you manually place the `MCPControls.StartMCPServer` node in your workspace to ensure connection stability and correct permissions.
2.  **Centralized Configuration (`mcp_config.json`)**: Global paths and user information are managed centrally through the configuration file, ensuring organized and logically consistent storage of scripts, examples, and test files.


> [!CRITICAL]
> **Important Notice Before Restarting Dynamo**: If you need to close or restart Dynamo, **please stop the Python Server first (Ctrl+C)**. Otherwise, the old connection will be held by the Python process, preventing the new Dynamo instance from binding to the port, resulting in "connection timeout" or "zombie connection" errors.

---

## üèóÔ∏è System Architecture

1.  **MCP Server (`server.py`)**:
    - Built with Python (`FastMCP`), responsible for translating AI natural language commands into Dynamo instructions.
    - **Dynamic Configuration**: Automatically reads `mcp_config.json` on startup to locate resource paths.
    - **Connection Detection**: Proactively checks whether the Dynamo listener is functioning properly before sending commands.

2.  **Dynamo Extension (`DynamoViewExtension/`)**:
    - Developed in C# with auto-loading capabilities.
    - Receives JSON commands and invokes Dynamo API through `GraphHandler`.
    - **Connection Robustness (v2.3)**: Implements "Force Takeover" mechanism and automatic cleanup on window lifecycle (Window.Closed) event, effectively resolving connection deadlock issues in Revit multi-window environments.

3.  **MCP Client**:
    - **Claude Desktop / AI Agent**: Integrates `server.py` through configuration files.
    - **Automated Testing**: Various functional verification tools located in the `tests/` folder.

---

## üìÇ Project Structure

- **`mcp_config.template.jsonc`**: **[Configuration Template]** Configuration template with Traditional Chinese comments; users should edit this file.
- **`mcp_config.json`**: **[Auto-Generated]** Pure JSON configuration file converted from the template for program use (do not edit manually).
- `docs/CONFIG_GUIDE.md`: **[Configuration Guide]** Detailed instructions on how to modify the configuration file.
- `server.py`: Main MCP server defining the toolset (Tools) invoked by AI.
- `DynamoViewExtension/`: C# source code, including `common_nodes.json` (node signature definitions).
- `DynamoScripts/`: Script library storing tested and commonly used Dynamo JSON graph definitions.
- **`domain/`**: **[SOP Knowledge Base]** Standard Operating Procedures and troubleshooting guides.
  - `startup_checklist.md`: Startup checklist (required reading for AI initialization)
  - `troubleshooting.md`: Complete troubleshooting procedures
- `tests/`: Contains all verification, performance testing, and functional checking Python scripts. **(This utility directory is ignored by Git; scripts will not be uploaded)**
- `examples/`: Reference examples for developers.
- `image/`: **[Visualization Output]** Stores script analysis charts and technical documentation generated by the `/image` command. **(This output directory is ignored by Git; images will not be uploaded)**
- `deploy.ps1`: **[One-Click Deployment]** Compiles and installs the plugin to the Dynamo package path.
- **`GEMINI.md`**: **[AI Required Reading]** Complete operational guidelines and node creation methods.
- **`QUICK_REFERENCE.md`**: **[Quick Reference]** Common examples and troubleshooting guide.

---

## üõ†Ô∏è Installation and Deployment

1.  **Environment Requirements**:
    - **.NET 8 SDK**.
    - **Revit 2025** + **Dynamo 3.3** (or compatible versions).
2.  **Configuration Setup** (First-time Use):
    - Edit `mcp_config.template.jsonc` and modify items marked with üîß (such as username, server port number).
    - For detailed instructions, refer to [`docs/CONFIG_GUIDE.md`](docs/CONFIG_GUIDE.md).
3.  **Execute Deployment**:
    - Completely close Revit and Dynamo.
    - Run in the project directory: `.\deploy.ps1`
    - The script will automatically:
      1. Convert the template to `mcp_config.json`
      2. Build the C# project
      3. Install the plugin to the `%AppData%` package folder

---

## üî• Core Operational Tools (AI Tools)

| Tool Name | Functionality | Use Case |
|---------|---------|----------|
| `execute_dynamo_instructions` | Place nodes and connectors on the canvas | Core automated modeling |
| `clear_workspace` | **[NEW]** One-click workspace clearing | Redesign or redrawing |
| `analyze_workspace` | Query current node status and errors | Debugging and status checking |
| `list_available_nodes` | Search available Dynamo nodes (including .dyf) | Find modeling tools |
| `save/load_script_to_library` | Persist snapshot scripts to script library | Modular reuse |

> [!TIP]
> **Prevent Overlapping Features**: When executing `execute_dynamo_instructions`, you can set `clear_before_execute=True` to automatically clear the canvas before drawing new geometry.

> [!IMPORTANT]
> **Ensure Stable Connection**: Please make sure to place the `MCPControls.StartMCPServer` node in your Dynamo workspace. This ensures the HTTP server operates in the correct context, avoiding connection interruptions due to auto-start mechanism recycling or insufficient permissions.

---

## üè• System Health Check

The new version supports health check endpoints for real-time system status queries and problem diagnosis:

**Usage Example**:
```python
import urllib.request, json

req = urllib.request.Request(
    "http://127.0.0.1:5050/mcp/",
    data=json.dumps({"action": "health_check"}).encode(),
    headers={'Content-Type': 'application/json'}
)
response = urllib.request.urlopen(req)
health = json.loads(response.read().decode())
print(f"Status: {health['status']}, Uptime: {health['uptimeSeconds']} seconds")
```

**Response Example**:
```json
{
  "status": "healthy",
  "version": "2.3",
  "sessionId": "abc-123...",
  "processId": 12345,
  "uptimeSeconds": 3600,
  "workspace": {"name": "Home", "nodeCount": 15}
}
```

## üìñ Usage and Control (Antigravity)

Add the following to Antigravity's MCP configuration:
```json
"dynamo-mcp": {
  "command": "python",
  "args": ["absolute/path/to/server.py"]
}
```
Then control via commands in your preferred language, for example: "Please draw a 100x100 cuboid, clear the canvas first".

---

## ‚öñÔ∏è License

Copyright 2026 ChimingLu.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
