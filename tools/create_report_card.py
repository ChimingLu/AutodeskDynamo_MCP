
import matplotlib.pyplot as plt
import matplotlib.patches as patches
import matplotlib.font_manager as fm
import json
import textwrap

# è¨­å®šä¸­æ–‡å­—å‹
font_path = r'C:\Windows\Fonts\msjh.ttc'
prop_bold = fm.FontProperties(fname=r'C:\Windows\Fonts\msjhbd.ttc')
prop = fm.FontProperties(fname=font_path)

# åœ–è¡¨è¨­å®š
width, height = 1200, 1600
dpi = 100
fig, ax = plt.subplots(figsize=(width/dpi, height/dpi), dpi=dpi)
ax.set_facecolor('#121212')  # éå¸¸æ·±çš„èƒŒæ™¯
fig.patch.set_facecolor('#121212')
ax.axis('off')

# æ¨¡æ“¬è®€å– Markdown è³‡è¨Š (å› ç‚ºè§£æ Markdown æ¯”è¼ƒéº»ç…©ï¼Œé€™è£¡ç›´æ¥ç”¨æˆ‘å€‘å·²çŸ¥çš„ä¸€è‡´è³‡è¨Š)
# é€™æ¨£å¯ä»¥ç¢ºä¿åœ–ç‰‡å…§å®¹èˆ‡ image/Home_analysis.md å’Œ maximize_view_flowchart.png ä¸€è‡´
report_data = {
    "title": "æœ€å¤§åŒ–çª—å¤–è¦–é‡ (Maximize View)",
    "subtitle": "Dynamo æŠ€è¡“åˆ†æå ±å‘Š | v3.4",
    "date": "2026-02-19",
    "stats": [
        ("ç¯€é»ç¸½æ•¸ (Nodes)", "127", "#00bcd4"),
        ("é€£ç·šç¸½æ•¸ (Connectors)", "158", "#e91e63"),
        ("è¤‡é›œåº¦ (Complexity)", "â­â­â­â­", "#ffeb3b")
    ],
    "inputs": [
        "1. é¸å–æˆ¿é–“ (Select Room)",
        "2. é¸å–è¨ˆç®—å…ƒç´  (Select Elements)",
        "3. é¸å–çª—æˆ¶/å¸·å¹• (Select Windows)",
        "4. é¸å–éšœç¤™ç‰© (Select Obstacles)",
        "5. è¨­å®šæª¢è¦–é» (Viewer Position X,Y)"
    ],
    "logic": [
        "1. è®€å–æˆ¿é–“é‚Šç•Œèˆ‡éšœç¤™ç‰©å¹¾ä½•",
        "2. ç”¢ç”Ÿè¦–ç·šå‘é‡ (Python Script)",
        "3. æª¢æ¸¬éšœç¤™ç‰©é®æ“‹ (IsIntersect)",
        "4. è¨ˆç®—è¦–é‡å“è³ªåˆ†æ•¸ (0-100)",
        "5. è¦–è¦ºåŒ–é¡è‰²æ˜ å°„ (Cyan-Magenta)"
    ],
    "outputs": [
        "1. çª—å¤–è¦–é‡åˆ†æ•¸ (View Score)",
        "2. åˆ°çª—æˆ¶çš„è·é›¢ (Distance to Window)",
        "3. èˆ‡çª—æˆ¶çš„å¹³å‡è§’åº¦ (Average Angle)",
        "4. å¹¾ä½•è¦–è¦ºåŒ–é¡¯ç¤º (Geometry Color)"
    ]
}

# ç¹ªè£½æ¨™é¡Œå€
header_height = 0.85
ax.text(0.5, 0.95, report_data["title"], ha='center', va='center', fontsize=36, color='white', fontproperties=prop_bold)
ax.text(0.5, 0.91, report_data["subtitle"], ha='center', va='center', fontsize=18, color='#aaaaaa', fontproperties=prop)

# ç¹ªè£½æ•¸æ“šå„€è¡¨æ¿
for i, (label, val, color) in enumerate(report_data["stats"]):
    x = 0.2 + i * 0.3
    y = 0.82
    # åœ“åœˆèƒŒæ™¯
    circle = patches.Circle((x, y), 0.12, linewidth=2, edgecolor=color, facecolor='none', alpha=0.8)
    ax.add_patch(circle)
    # æ•¸å€¼
    ax.text(x, y+0.01, val, ha='center', va='center', fontsize=32, color='white', fontproperties=prop_bold)
    # æ¨™ç±¤
    ax.text(x, y-0.08, label, ha='center', va='center', fontsize=12, color=color, fontproperties=prop)

# åˆ†éš”ç·š
ax.plot([0.1, 0.9], [0.68, 0.68], color='#333333', linewidth=2)

def draw_list_section(x, y, title, items, color):
    # æ¨™é¡Œ
    ax.text(x, y, title, ha='left', va='center', fontsize=20, color=color, fontproperties=prop_bold)
    # åˆ—è¡¨
    for i, item in enumerate(items):
        ax.text(x + 0.02, y - 0.05 - (i * 0.04), f"â€¢ {item}", ha='left', va='center', fontsize=14, color='#dddddd', fontproperties=prop)

# ç¹ªè£½è©³ç´°å…§å®¹å€
draw_list_section(0.15, 0.62, "ğŸ“¥ è¼¸å…¥åƒæ•¸ (Inputs)", report_data["inputs"], "#00bcd4")
draw_list_section(0.15, 0.38, "âš™ï¸ åŸ·è¡Œé‚è¼¯ (Logic)", report_data["logic"], "#ffeb3b")
draw_list_section(0.15, 0.14, "ğŸ“¤ ç”¢å‡ºçµæœ (Outputs)", report_data["outputs"], "#e91e63")

# é å°¾
ax.text(0.5, 0.02, "Generated by Dynamo MCP Agent", ha='center', va='center', fontsize=10, color='#444444', fontproperties=prop)

# å„²å­˜
output_file = "image/Home_analysis_card.png"
plt.tight_layout()
plt.savefig(output_file, dpi=dpi, bbox_inches='tight', facecolor='#121212')
print(f"Report card saved to {output_file}")
